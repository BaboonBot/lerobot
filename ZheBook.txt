# Rosmaster Robot LeRobot Usage Guide

## Overview
This guide covers the complete usage of the Rosmaster robot with LeRobot framework, including teleoperation and data recording capabilities using the combined arm+base control teleoperator.

## Hardware Setup
- **Robot**: Yahboom Rosmaster 6-DOF robot arm with mecanum wheel base
- **Connection**: USB serial adapter connected to `/dev/myserial`
- **Firmware**: Version 3.5 (verified working)
- **Cameras**: 
  - Front camera: `/dev/video0` (USB 2.0 Camera - may have stability issues during continuous streaming)
  - Side camera: `/dev/video2` (USB 2.0 Camera - reliable, recommended primary camera)
  - **Camera Status**: Both cameras work for image capture, `/dev/video2` recommended for continuous streaming
- **Joint Range**: Each servo operates from 0Â° to 180Â°
- **Base Movement**: 4x mecanum wheels supporting omnidirectional movement

## Teleoperation Method

### Combined Teleoperator (rosmaster_combined)

The combined teleoperator provides unified control of both the robot arm and mecanum wheel base through a single keyboard interface.

#### Command:
```bash
# Recommended: Use reliable side camera
lerobot-teleoperate \
  --robot.type=rosmaster \
  --robot.com="/dev/myserial" \
  --robot.id="my_rosmaster_robot" \
  --robot.cameras='{"side": {"type": "opencv", "index_or_path": "/dev/video2", "width": 640, "height": 480, "fps": 30}}' \
  --teleop.type=rosmaster_combined \
  --teleop.joint_step=2.0 \
  --teleop.movement_step=0.3 \
  --teleop.rotation_step=0.5 \
  --display_data=true

# Alternative: Use both cameras (may have stability issues with /dev/video0)
lerobot-teleoperate \
  --robot.type=rosmaster \
  --robot.com="/dev/myserial" \
  --robot.id="my_rosmaster_robot" \
  --robot.cameras='{"front": {"type": "opencv", "index_or_path": "/dev/video0", "width": 640, "height": 480, "fps": 30}, "side": {"type": "opencv", "index_or_path": "/dev/video2", "width": 640, "height": 480, "fps": 30}}' \
  --teleop.type=rosmaster_combined \
  --teleop.joint_step=2.0 \
  --teleop.movement_step=0.3 \
  --teleop.rotation_step=0.5 \
  --display_data=true
```

#### Key Controls:

**Mecanum Wheel Controls (Base Movement):**
- **w/s**: Forward/Backward movement
- **a/d**: Strafe Left/Right movement  
- **q/e**: Rotate Left/Right

**Arm Joint Controls:**
- **t/g**: Joint 1 (+/-) - Base rotation
- **y/h**: Joint 2 (+/-) - Shoulder
- **u/j**: Joint 3 (+/-) - Elbow
- **i/k**: Joint 4 (+/-) - Wrist pitch
- **o/l**: Joint 5 (+/-) - Wrist roll
- **p/;**: Joint 6 (+/-) - Gripper

**Safety Controls:**
- **SPACE**: Lock/Unlock all controls (SAFETY FEATURE)
- **ESC**: Disconnect
- **p/;**: Joint 6 (+/-) - Gripper
- **SPACE**: Lock/Unlock position (SAFETY FEATURE - robot starts locked!)
- **ESC**: Disconnect and exit

**Note**: Key mapping has been updated for better ergonomics and to avoid conflicts with base movement controls.

#### Usage Steps:
1. Run the command above
2. **IMPORTANT**: Press SPACE to unlock the robot (starts locked for safety)
3. Use the key combinations to move joints
4. Press SPACE again to lock position when done
5. Press ESC to exit

#### Safety Notes:
- Robot starts with position LOCKED - you must press SPACE to unlock
- Look for messages: "ðŸ”’ LOCKED" or "ðŸ”“ UNLOCKED"
- Always lock position when not actively controlling
## Data Recording

### Basic Recording Command

Record demonstrations using either teleoperator:

#### With KeyboardCombined Control:
```bash
lerobot-record \
  --robot.type=rosmaster \
  --robot.com="/dev/myserial" \
  --robot.id="my_rosmaster_robot" \
  --robot.cameras="{front: {type: opencv, index_or_path: /dev/video0, width: 640, height: 480, fps: 30}}" \
  --teleop.type=rosmaster_combined \
  --teleop.joint_step=2.0 \
  --dataset.repo_id="local_user/my_recording" \
  --dataset.single_task="Task description" \
  --dataset.num_episodes=5 \
  --dataset.episode_time_s=15 \
  --dataset.reset_time_s=5 \
  --dataset.fps=10 \
  --dataset.push_to_hub=false \
  --dataset.root="data/recordings" \
  --display_data=true
```

#### With Terminal Control:
```bash
lerobot-record \
  --robot.type=rosmaster \
  --robot.com="/dev/myserial" \
  --robot.id="my_rosmaster_robot" \
  --robot.cameras="{front: {type: opencv, index_or_path: /dev/video0, width: 640, height: 480, fps: 30}}" \
  --teleop.type=rosmaster_combined \
  --teleop.joint_step=2.0 \
  --teleop.movement_step=0.3 \
  --teleop.rotation_step=0.5 \
  --dataset.repo_id="local_user/my_recording" \
  --dataset.single_task="Task description" \
  --dataset.num_episodes=5 \
  --dataset.episode_time_s=15 \
  --dataset.reset_time_s=5 \
  --dataset.fps=10 \
  --dataset.push_to_hub=false \
  --dataset.root="data/recordings" \
  --display_data=true
```

### Dual Camera Recording

For recording with both front and wrist cameras:

```bash
lerobot-record \
  --robot.type=rosmaster \
  --robot.com="/dev/myserial" \
  --robot.id="my_rosmaster_robot" \
  --robot.cameras="{front: {type: opencv, index_or_path: /dev/video0, width: 640, height: 480, fps: 30}, wrist: {type: opencv, index_or_path: /dev/video2, width: 640, height: 480, fps: 30}}" \
  --teleop.type=rosmaster_combined \
  --teleop.joint_step=2.0 \
  --teleop.movement_step=0.3 \
  --teleop.rotation_step=0.5 \
  --teleop.joint_step=2.0 \
  --dataset.repo_id="NLTuan/dual_camera_demo" \
  --dataset.single_task="Dual camera demonstration" \
  --dataset.num_episodes=3 \
  --dataset.episode_time_s=10 \
  --dataset.reset_time_s=5 \
  --dataset.fps=10 \
  --dataset.push_to_hub=true \
  --dataset.root="data/dual_recordings" \
  --display_data=true
```

### Recording Parameters Explained

- **`--robot.type=rosmaster`**: Robot type
- **`--robot.com="/dev/myserial"`**: Serial port (updated from ttyUSB0)
- **`--robot.id`**: Unique identifier for this robot
- **`--robot.cameras`**: Camera configuration (JSON format)
- **`--teleop.type`**: Must be `rosmaster_combined`
- **`--teleop.joint_step`**: Step size for keyboard control (degrees)
- **`--dataset.repo_id`**: Dataset identifier  
- **`--dataset.single_task`**: Description of the task being recorded
- **`--dataset.num_episodes`**: Number of episodes to record
- **`--dataset.episode_time_s`**: Duration of each episode (seconds)
- **`--dataset.reset_time_s`**: Time between episodes for resetting
- **`--dataset.fps`**: Recording frame rate
- **`--dataset.push_to_hub`**: Upload to HuggingFace Hub (true/false)
- **`--dataset.root`**: Local storage directory
- **`--display_data`**: Show real-time data during recording

### Quick Recording Examples

#### 10-Second Episodes (3 episodes):
```bash
lerobot-record \
  --robot.type=rosmaster \
  --robot.com="/dev/myserial" \
  --robot.id="demo_robot" \
  --robot.cameras="{front: {type: opencv, index_or_path: /dev/video0, width: 640, height: 480, fps: 30}}" \
  --teleop.type=rosmaster_combined \
  --teleop.joint_step=2.0 \
  --teleop.movement_step=0.3 \
  --teleop.rotation_step=0.5 \
  --dataset.repo_id="local_user/quick_demo" \
  --dataset.single_task="Quick demonstration" \
  --dataset.num_episodes=3 \
  --dataset.episode_time_s=10 \
  --dataset.reset_time_s=5 \
  --dataset.fps=10 \
  --dataset.push_to_hub=false \
  --dataset.root="data/quick_demo" \
  --display_data=true
```

## Troubleshooting

### Common Issues:

1. **Robot not moving in keyboard mode**:
   - Solution: Press SPACE to unlock position control
   - Look for "ðŸ”“ UNLOCKED" message

2. **Serial port permission denied**:
   ```bash
   sudo chmod 666 /dev/myserial
   ```

3. **Camera not found**:
   ```bash
   ls -la /dev/video*  # Check available cameras
   v4l2-ctl --list-devices  # Show camera details
   ```

4. **Camera connection issues**:
   - `/dev/video0` may have USB stability issues during continuous streaming
   - **Solution**: Use `/dev/video2` which is more reliable
   - Check kernel logs: `sudo dmesg | grep -E "(video|uvc)" | tail -10`
   - USB URB errors indicate power/bandwidth issues

5. **Camera read failures during teleoperation**:
   - Error: "OpenCVCamera read failed (status=False)"
   - **Solution**: 
     - Use only `/dev/video2` camera
     - Try different USB ports
     - Use powered USB hub if available
     - Reduce fps or resolution if needed

6. **Position instability (angles returning to 90Â°)**:
   - **Fixed**: Position feedback system updated
   - Robot now maintains commanded positions properly
   - No longer forces return to default 90Â° angles

7. **Warnings in terminal**:
   - Motor read warnings are normal and suppressed
   - Recording continues without issues

### Joint Mapping:
- **servo_1**: Base rotation (0-180Â°)
- **servo_2**: Shoulder (0-180Â°)
- **servo_3**: Elbow (0-180Â°)
- **servo_4**: Wrist pitch (0-180Â°)
- **servo_5**: Wrist roll (0-180Â°)
- **servo_6**: Gripper (0-180Â°)

### Default Positions:
All servos start at 90Â° (middle position) for safety.

## Data Output Structure

Recorded data is saved in LeRobot format:

```
data/recordings/
â”œâ”€â”€ data/
â”‚   â””â”€â”€ chunk-000/
â”‚       â””â”€â”€ train-00000-of-00001.parquet  # Tabular data
â”œâ”€â”€ meta/
â”‚   â”œâ”€â”€ info.json                         # Dataset metadata
â”‚   â””â”€â”€ stats.safetensors                 # Dataset statistics
â””â”€â”€ videos/
    â””â”€â”€ chunk-000/
        â””â”€â”€ observation.images.front/
            â””â”€â”€ episode_000000.mp4       # Video data
```

This data format is ready for training LeRobot policies and uploading to HuggingFace Hub.

## Tips for Best Results

1. **Use keyboard teleop for dynamic movements**
2. **Use terminal teleop for precise positioning**
3. **Start with short episodes (10-15 seconds)**
4. **Always reset robot position between episodes**
5. **Record multiple demonstrations of the same task**
6. **Ensure good lighting for cameras**
7. **Keep workspace clear of obstacles**

## Recent Updates and Fixes

### Camera System (October 12, 2025)
- **Identified camera stability issues**: `/dev/video0` has USB URB failures during continuous streaming
- **Recommended setup**: Use `/dev/video2` as primary camera (more stable)
- **Dual camera support**: Both cameras work but `/dev/video0` may disconnect during long sessions
- **Troubleshooting added**: USB bandwidth and power issue diagnostics

### Position Control System (October 12, 2025)  
- **Fixed position instability**: Robot no longer returns to 90Â° default angles
- **Improved feedback system**: Position commands now properly maintained
- **Enhanced safety**: All teleoperators start in LOCKED mode
- **Updated key mappings**: Keyboard controls moved to tgyh ujik olp; layout

### System Performance
- **Frame rates**: Stable 30-35 Hz operation with single camera
- **Firmware**: Version 3.5 verified and working
- **Joint step sizes**: Increased to 10.0Â° for faster movement
- **Movement parameters**: Optimized for responsive control

### Viewing System
- **Rerun viewer**: Available at `http://localhost:9876` for live camera feeds
- **Real-time telemetry**: Joint positions and camera streams displayed
- **Multi-camera support**: Side-by-side view when both cameras working

---
*Last updated: October 12, 2025*
*LeRobot version: Compatible with Rosmaster integration*
*Camera issues diagnosed and documented*
*Position stability system fixed*
